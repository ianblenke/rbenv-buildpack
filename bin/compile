#!/usr/bin/env bash

set -ex

if curl http://169.254.169.254/latest/meta-data/placement/availability-zone -s ; then
  availability_zone=$(curl http://169.254.169.254/latest/meta-data/placement/availability-zone -s | sed -e 's/.$//')
  perl -pi -e "s%archive.ubuntu.com/ubuntu%${availaiblity_zone}.ec2.archive.ubuntu.com/ubuntu%g" /etc/apt/sources.list
  apt-get update
  LC_ALL=C DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -f -y
fi

[ -d /usr/local/rbenv ] || git clone https://github.com/sstephenson/rbenv.git /usr/local/rbenv

mkdir -p /app/.profile.d
echo 'export RBENV_ROOT="/usr/local/rbenv"' >> /app/.profile.d/rbenv
echo 'export PATH="$RBENV_ROOT/bin:$PATH"' >> /app/.profile.d/rbenv
echo 'eval "$(rbenv init -)"' >> /app/.profile.d/rbenv
. /app/.profile.d/rbenv

[ -d /usr/local/rbenv/plugins/ruby-build ] || git clone https://github.com/sstephenson/ruby-build.git /usr/local/rbenv/plugins/ruby-build

LC_ALL=C DEBIAN_FRONTEND=noninteractive apt-get install autoconf bison build-essential libssl-dev zlib1g zlib1g-dev -f -y

[ -f /app/.ruby-version ] && rbenv install $(cat /app/.ruby-version)

ruby_version=$(grep -e '^ruby ' | sed -e 's/^ruby //') || true
[ -z $ruby_version ] || rbenv install $ruby_version

[ -f /app/Gemfile ] && bash -c "
  . /app/.profile.d/rbenv
  rbenv rehash
  which ruby
  ruby --version
  which gem
  gem --version
  gem install bundler
  cd /app
  which bundle
  bundle --version
  bundle install
" || true

mkdir -p /usr/local/rbenv/.profile.d
[ -f /usr/local/rbenv/.profile.d/rbenv] || cp -f /app/.profile.d/rbenv /usr/local/rbenv/.profile.d/rbenv

